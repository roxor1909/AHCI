<head>
    <title>Streamer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script>
        const camerWidth = 640;
        const camerHeight = 480;
        

        // trys to connect to the host that serves the page by default
        const socket = io();

        socket.on('connection', (socket) => {
            console.log('a user connected');
            socket.emit('camera_frame', {camerWidth: camerWidth, camerHeight: camerHeight});

            socket.on('disconnect', () => {
                console.log('user disconnected');
            });
        });
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <canvas id="canvas"></canvas>

    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSgl1xvVrKLnSEwGqMDMxUIY8VexNQ9WLMOKwhgSevscEnVcwsT&s"
        id="clock" hidden>
    <img src="https://ak5.picdn.net/shutterstock/videos/16504675/thumb/4.jpg" id="graph" hidden>
    <img src="https://icon-library.net/images/achievement-icon/achievement-icon-16.jpg" id="achievements" hidden>

    <video autoplay></video>

    <canvas id="reCanvas" ></canvas>
    <div id="responses"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.5.0/fabric.min.js"></script>
    <script>

        let fabricCanvas;
        let greetingTextInstance;
        let clockInstance;
        let graphInstance;
        let achievementsInstance;

        let lastXPositionClock = 0;
        let lastYPositionClock = 0;
        let lastXPositionGraph = 0;
        let lastYPositionGraph = 0;
        let lastXPositionAchievements = 0;
        let lastYPositionAchievements = 0;
        let lastMatchedPerson;


        // get video dom element
        const video = document.querySelector('video');

        const canv = document.getElementById('reCanvas');
        canv.width = camerWidth;
        canv.height = camerHeight;
        const ctx = canv.getContext('2d');

        // request access to webcam
        navigator.mediaDevices.getUserMedia({ video: { width: camerWidth, height: camerHeight } }).then((stream) => video.srcObject = stream);

        // returns a frame encoded in base64
        const getFrame = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const data = canvas.toDataURL();
            return data;
        }

        const sendMessage = (data) => {
            socket.emit('camera_frame', { framedata: data });
        }

        function showUserGreeting(matchedPerson) {
            if (matchedPerson === lastMatchedPerson) {
                // return immediately when no changes since last frame
                return;
            }

            let greeting;
            
            // hide greeting when no person was recognized
            if (matchedPerson === null) {
                greeting =  '';
            } else if (matchedPerson === '') {
                greeting = getGreetingForHourOfDay() + '.';
            } else if (matchedPerson !== '') {
                greeting = getGreetingForHourOfDay() + ', ' + matchedPerson.charAt(0).toUpperCase() + matchedPerson.slice(1) + '.';
            }
            if (greetingTextInstance) {
                fabricCanvas.remove(greetingTextInstance);
            }
            greetingTextInstance = new fabric.Text(greeting, {
                fontFamily: 'Arial',
                left: 100,
                top: 100,
                fill: '#FFFFFF',
                fontSize: 80
            });
            fabricCanvas.add(greetingTextInstance);

            lastMatchedPerson = matchedPerson;
        }

        function getGreetingForHourOfDay() {
            const h = new Date().getHours();
            if (h < 4) {
                return 'Good night';
            } else if (h < 11) {
                return 'Good morning';
            } else if (h < 17) {
                return 'Good afternoon';
            } else if (h < 21) {
                return 'Good evening';
            }
            return 'Good night';
        }

        socket.on('response_message', (msg) => {
            const json = JSON.parse(msg);
            showUserGreeting(json.matchedPerson);
/*
            if (lastXPositionClock != json.clock.x || lastYPositionClock != json.clock.y) {
                lastXPositionClock = json.clock.x;
                lastYPositionClock = json.clock.y;
                fabricCanvas.item(0).animate('left', json.clock.x, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
                fabricCanvas.item(0).animate('top', json.clock.y, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
            }
            if (lastXPositionGraph != json.graph.x || lastYPositionGraph != json.graph.y) {
                lastXPositionGraph = json.graph.x;
                lastYPositionGraph = json.graph.y;
                fabricCanvas.item(1).animate('left', json.graph.x, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
                fabricCanvas.item(1).animate('top', json.graph.y, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
            }
            if (lastXPositionAchievements != json.achievements.x || lastYPositionAchievements != json.achievements.y) {
                lastXPositionAchievements = json.achievements.x;
                lastYPositionAchievements = json.achievements.y;
                fabricCanvas.item(2).animate('left', json.achievements.x, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
                fabricCanvas.item(2).animate('top', json.achievements.y, {
                    duration: 1000,
                    onChange: fabricCanvas.renderAll.bind(fabricCanvas)
                });
            }*/
            // document.getElementById("responses").appendChild(document.createTextNode(msg))

            json.boundingBoxes.forEach(el => {

                if (el['class'] !== 'person') {
                    return
                }

                const bb = el['bounding_box'];
                const xDist = bb['xmax'] - bb['xmin'];
                const yDist = bb['ymax'] - bb['ymin'];

                const xCenter = bb['xmin'] + xDist/2;
                const yCenter = bb['ymin'] + yDist/2;

                ctx.clearRect(0, 0, camerWidth, camerHeight);
                ctx.strokeStyle = "#FFFFFF";
                ctx.beginPath();
                ctx.rect(bb['xmin'], bb['ymin'], xDist, yDist);
                ctx.stroke();
                
            });


        });

        setInterval(() => {
            sendMessage(getFrame());
        }, 1000);

        function initializeCanvas() {
            document.getElementById('canvas').width = window.innerWidth;
            document.getElementById('canvas').height = window.innerHeight;
            fabricCanvas = new fabric.Canvas('canvas');

/*            const clockImage = document.getElementById('clock');
            clockInstance = new fabric.Image(clockImage, {
                left: 0,
                top: 150
            });
            const graphImage = document.getElementById('graph');
            graphInstance = new fabric.Image(graphImage, {
                left: 500,
                top: 0
            });
            const achievementsImage = document.getElementById('achievements');
            achievementsInstance = new fabric.Image(achievementsImage, {
                left: 1500,
                top: 0
            });
            fabricCanvas.add(clockInstance);
            fabricCanvas.add(graphInstance);
            fabricCanvas.add(achievementsInstance);*/
        }

        (function () {
            initializeCanvas();
        })();

    </script>
</body>

</html>